<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>Life and Ministry Timer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .progress-bar span {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        .part-card {
            transition: border-color 0.2s ease;
        }
        .part-card:hover {
            border-color: #3b82f6;
        }
        #commentSection {
            transition: all 0.3s ease;
        }
        #commentHistory::-webkit-scrollbar {
            width: 6px;
        }
        
        #commentHistory::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        #commentHistory::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        #commentHistory::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .progress-bar {
            position: relative;
            display: flex;
            align-items: center;
        }
    </style>
</head>

<body class="bg-gray-100 p-4">
    <main class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
        <!-- Template Section -->
        <section aria-labelledby="template-heading" class="space-y-6">
            <header class="flex justify-between items-center">
                <h1 id="template-heading" class="text-xl font-bold">Meeting Template</h1>
                <div class="space-x-2">
                    <button 
                        onclick="resetData()" 
                        class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
                        aria-label="Reset all timers">
                        Reset Timers
                    </button>
                    <button 
                        onclick="clearLocalStorage()" 
                        class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
                        aria-label="Clear template and reset all data">
                        Clear Template
                    </button>
                </div>
            </header>
            
            <div id="partsTemplate" class="space-y-2" role="form" aria-label="Meeting parts template">
                <!-- Parts will be rendered here -->
            </div>
            
            <button 
                onclick="addPart()" 
                class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                aria-label="Add new meeting part">
                Add Part
            </button>
        </section>

        <!-- Comment History Section -->
        <section aria-labelledby="comment-heading" class="mt-8 p-4 bg-gray-50 rounded-lg">
            <h2 id="comment-heading" class="text-lg font-bold mb-4">Comment History</h2>
            <div id="globalCommentStats" class="mb-4">
                <p>Total Comments: <span id="globalCommentCount" class="font-semibold" aria-live="polite">0</span></p>
                <p>Average Duration: <span id="globalAverageDuration" class="font-semibold" aria-live="polite">0:00</span></p>
            </div>
            <div id="commentHistory" 
                 class="space-y-2 max-h-40 overflow-y-auto"
                 role="log" 
                 aria-label="Comment history list">
                <!-- Comments will be listed here -->
            </div>
        </section>
        
        <!-- Timer Display Section -->
        <section aria-labelledby="timer-heading" class="space-y-4 mt-8">
            <h2 id="timer-heading" class="text-xl font-bold">Meeting Timer</h2>
            <div id="partsDisplay" 
                 class="space-y-4"
                 role="region" 
                 aria-label="Active timers">
                <!-- Timer displays will be inserted here -->
            </div>
        </section>
    </main>
</body>

    <script>
 // Constants and State
    const DEFAULT_PARTS = [
        { name: 'Opening Comments', duration: 180, speaker: '', enableComments: false },
        { name: 'Treasures', duration: 600, speaker: '', enableComments: false },
        { name: 'Spiritual Gems', duration: 600, speaker: '', enableComments: true},
        { name: 'Bible Reading', duration: 300, speaker: '', enableComments: false },
        { name: 'Apply yourself 1', duration: 180, speaker: '', enableComments: false },
        { name: 'Apply yourself 2', duration: 180, speaker: '', enableComments: false },
        { name: 'Student Talk', duration: 300, speaker: '', enableComments: false },
        { name: 'CBS', duration: 1800, speaker: '', enableComments: false }
   ];
        const COMMENT_LIMIT = 240; // 4 minutes in seconds
        
        let meetingParts = [];
        let activePart = 0;
        let isRunning = false;
        let elapsedTimes = {};
        let timerInterval = null;
        let commentInterval = null;

        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .trim();
        }
        
    function formatTime(seconds) {
        const mins = Math.floor(Math.abs(seconds) / 60);
        const secs = Math.abs(seconds) % 60;
        const sign = seconds < 0 ? '-' : '';
        return `${sign}${mins}:${secs.toString().padStart(2, '0')}`;
    }
    // Comment Management
        let comments = JSON.parse(localStorage.getItem('meetingComments')) || [];
        let activeComment = null;
        
    function toggleComment(partIndex) {
        // Prevent comments if timer isn't running for this part
        if (activePart !== partIndex || !isRunning) {
            alert('Part timer must be running to record comments!');
            return;
        }
        
        // Prevent multiple active comments
        if (activeComment && activeComment.partIndex !== partIndex) return;
    
        if (activeComment) {
            // Stop existing comment
            const duration = Math.floor((Date.now() - activeComment.startTime) / 1000);
            
            // Duration validations moved inside this block where 'duration' exists
            if (duration < 5) {
                alert('Comment too short!');
                return;
            }
            
            let finalDuration = duration;
            if (duration > COMMENT_LIMIT) {
                finalDuration = COMMENT_LIMIT;
                alert('Maximum comment duration reached!');
            }
    
            comments.push({
                duration: finalDuration,
                timestamp: Date.now(),
                partName: meetingParts[partIndex].name
            });
            
            try {
                localStorage.setItem('meetingComments', JSON.stringify(comments));
            } catch (error) {
                console.error('Failed to save comments:', error);
                alert('Failed to save comment. Please try again.');
            }
            
            activeComment = null;
            clearInterval(commentInterval);
            updateGlobalComments();
        } else {
            // Start new comment
            activeComment = {
                startTime: Date.now(),
                partIndex: partIndex
            };
            
            commentInterval = setInterval(() => {
                const currentElement = document.getElementById(`currentComment-${partIndex}`);
                if (currentElement) {
                    currentElement.textContent = formatTime(
                        Math.floor((Date.now() - activeComment.startTime) / 1000)
                    );
                }
            }, 200);
        }
        
        renderTimerDisplay();
    }

        function saveState() {
            localStorage.setItem('elapsedTimes', JSON.stringify(elapsedTimes));
            localStorage.setItem('activePart', activePart);
        }
        function loadState() {
            const savedTimes = localStorage.getItem('elapsedTimes');
            if (savedTimes) {
                elapsedTimes = JSON.parse(savedTimes);
            }
            activePart = parseInt(localStorage.getItem('activePart')) || 0;
        }
        
    function updateGlobalComments() {
        // Update stats
        document.getElementById('globalCommentCount').textContent = comments.length;
        const average = comments.length > 0 
            ? Math.floor(comments.reduce((a, b) => a + b.duration, 0) / comments.length)
            : 0;
        document.getElementById('globalAverageDuration').textContent = formatTime(average);
      // Update history list
            const historyContainer = document.getElementById('commentHistory');
            historyContainer.innerHTML = comments.map((comment, i) => `
                <div class="bg-white p-2 rounded shadow-sm">
                    <div class="flex justify-between text-sm">
                        <span>Comment ${i+1}</span>
                        <span>${formatTime(comment.duration)}</span>
                    </div>
                    <div class="text-xs text-gray-500">
                        ${new Date(comment.timestamp).toLocaleTimeString()}
                    </div>
                </div>
            `).join('');
        }
        
    function getProgressInfo(elapsed, duration) {
        const progress = Math.min((elapsed / duration) * 100, 100);
        const timeRemaining = duration - elapsed;
        let color = 'bg-blue-500';
        if (timeRemaining <= duration * 0.1 && timeRemaining > 0) {
            color = 'bg-yellow-500';
        } else if (timeRemaining <= 0) {
            color = 'bg-red-500';
        }
        return { progress, color };
    }
     
    function renderTemplate() {
        const container = document.getElementById('partsTemplate');
        if (!container) return;
        
        container.innerHTML = meetingParts.map((part, index) => `
            <div class="flex items-center space-x-2" role="group" aria-label="Meeting part ${index + 1}">
                <div class="flex-1 grid grid-cols-3 gap-2">
                    <div class="flex flex-col">
                        <label for="part-name-${index}" class="sr-only">Part Name</label>
                        <input
                            id="part-name-${index}"
                            value="${sanitizeInput(part.name)}"
                            onchange="updatePart(${index}, 'name', this.value)"
                            placeholder="Part Name"
                            class="px-3 py-2 border rounded"
                            aria-label="Name for part ${index + 1}"
                        />
                    </div>
                    <div class="flex flex-col">
                        <label for="part-duration-${index}" class="sr-only">Duration in Minutes</label>
                        <input
                            id="part-duration-${index}"
                            type="number"
                            value="${part.duration / 60}"
                            onchange="updatePart(${index}, 'duration', this.value)"
                            placeholder="Minutes"
                            class="px-3 py-2 border rounded"
                            aria-label="Duration in minutes for part ${index + 1}"
                            min="0"
                        />
                    </div>
                    <div class="flex flex-col">
                        <label for="part-speaker-${index}" class="sr-only">Speaker Name</label>
                        <input
                            id="part-speaker-${index}"
                            value="${sanitizeInput(part.speaker)}"
                            onchange="updatePart(${index}, 'speaker', this.value)"
                            placeholder="Speaker"
                            class="px-3 py-2 border rounded"
                            aria-label="Speaker name for part ${index + 1}"
                        />
                    </div>
                </div>
                <button 
                    onclick="movePart(${index}, -1)" 
                    ${index === 0 ? 'disabled' : ''} 
                    class="px-3 py-2 bg-gray-200 rounded"
                    aria-label="Move part ${index + 1} up"
                    ${index === 0 ? 'aria-disabled="true"' : ''}>
                    ↑
                </button>
                <button 
                    onclick="movePart(${index}, 1)" 
                    ${index === meetingParts.length - 1 ? 'disabled' : ''} 
                    class="px-3 py-2 bg-gray-200 rounded"
                    aria-label="Move part ${index + 1} down"
                    ${index === meetingParts.length - 1 ? 'aria-disabled="true"' : ''}>
                    ↓
                </button>
                <button 
                    onclick="removePart(${index})" 
                    class="px-3 py-2 bg-gray-200 rounded"
                    aria-label="Remove part ${index + 1}">
                    ×
                </button>
            </div>
        `).join('');
    }
        
    function addPart() {
        meetingParts.push({ 
            name: '', 
            duration: 180, 
            speaker: '', 
            enableComments: false  // Fixed syntax and initialization
        });
        saveTemplate();
        renderTemplate();
        renderTimerDisplay();
        }

     function updatePart(index, field, value) {
    if (field === 'duration') {
        value = Math.max(0, parseInt(value, 10) || 0) * 60;
    } else {
        value = sanitizeInput(value);
    }
    meetingParts[index][field] = value;
    saveTemplate();
    renderTimerDisplay();
}
        
    function movePart(index, direction) {
        if ((direction === -1 && index === 0) || (direction === 1 && index === meetingParts.length - 1)) return;
        [meetingParts[index], meetingParts[index + direction]] = [meetingParts[index + direction], meetingParts[index]];
        saveTemplate();
        renderTemplate();
        renderTimerDisplay();
    }

    function removePart(index) {
        meetingParts.splice(index, 1);
        saveTemplate();
        renderTemplate();
        renderTimerDisplay();
    }
    
    function saveTemplate() {
        localStorage.setItem('meetingTemplate', JSON.stringify(meetingParts));
    }
    
    function loadTemplate() {
        const saved = localStorage.getItem('meetingTemplate');
        meetingParts = saved ? JSON.parse(saved) : DEFAULT_PARTS;
        activePart = meetingParts.length > 0 ? 0 : null; // Auto-select first part
        renderTemplate();
        renderTimerDisplay();
    }
        
    function renderTimerDisplay() {
        const container = document.getElementById('partsDisplay');
        container.innerHTML = meetingParts.map((part, index) => {
            const elapsed = elapsedTimes[index] || 0;
            const { progress, color } = getProgressInfo(elapsed, part.duration);
            const timeRemaining = part.duration - elapsed;
            
            return `
                <div 
                    class="p-4 border rounded-lg part-card ${activePart === index ? 'border-blue-500' : 'border-gray-200'}"
                    onclick="selectPart(${index})"
                    role="region"
                    aria-label="Timer for ${sanitizeInput(part.name)}"
                    aria-selected="${activePart === index}"
                >
                    <div class="flex justify-between mb-2">
                        <span class="font-medium">${sanitizeInput(part.name)}</span>
                        <span aria-label="Speaker">${sanitizeInput(part.speaker)}</span>
                    </div>
                    <div 
                        class="h-8 bg-gray-200 rounded-full overflow-hidden relative"
                        role="progressbar"
                        aria-valuemin="0"
                        aria-valuemax="${part.duration}"
                        aria-valuenow="${elapsed}"
                        aria-label="Progress for ${sanitizeInput(part.name)}"
                    >
                        <div class="h-full ${color} progress-bar absolute" style="width: ${progress}%">
                            <span class="absolute left-2 text-white" aria-label="Elapsed time">${formatTime(elapsed)}</span>
                        </div>
                        <span class="absolute right-2" aria-label="Time remaining">${formatTime(timeRemaining)}</span>
                    </div>
    
                    ${part.enableComments ? `
                        <div class="mt-4 space-y-2">
                            <div class="flex items-center gap-2">
                                <button 
                                    onclick="event.stopPropagation(); toggleComment(${index})" 
                                    class="px-4 py-2 ${activeComment?.partIndex === index ? 'bg-red-500' : 'bg-purple-500'} text-white rounded"
                                    aria-label="${activeComment?.partIndex === index ? 'Stop comment' : 'Start comment'}"
                                >
                                    ${activeComment?.partIndex === index ? 'Stop Comment' : 'Start Comment'}
                                </button>
                                <span 
                                    id="currentComment-${index}" 
                                    class="text-sm ${activeComment ? '' : 'invisible'}"
                                    aria-live="polite"
                                    role="timer"
                                >
                                    ${activeComment ? formatTime(Math.floor((Date.now() - activeComment.startTime)/1000)) : '0:00'}
                                </span>
                            </div>
                        </div>
                    ` : ''}

                ${activePart === index ? `
                    <div class="mt-4 flex space-x-2">
                        <button 
                            onclick="event.stopPropagation(); toggleTimer()" 
                            class="px-4 py-2 ${isRunning ? 'bg-red-500' : 'bg-blue-500'} text-white rounded hover:bg-blue-600"
                            aria-label="${isRunning ? 'Pause timer' : 'Start timer'}"
                        >
                            ${isRunning ? 'Pause' : 'Start'}
                        </button>
                        <button 
                            onclick="event.stopPropagation(); startNextPart()" 
                            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                            aria-label="Begin next part"
                        >
                            Begin Next Part
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }
        function updateTimer() {
            if (activePart === null) return;
            elapsedTimes[activePart] = (elapsedTimes[activePart] || 0) + 1;
            renderTimerDisplay();
            // REMOVED the auto-stop functionality
        }
        
        function startNextPart() {
            if (activePart === null || activePart >= meetingParts.length - 1) return;
            activePart++;
            if (!isRunning) toggleTimer();
            renderTimerDisplay();
        }
        
        function selectPart(index) {
            if (isRunning) {
                alert('Cannot switch parts while timer is active!');
                return;
            }
            activePart = index;
            renderTimerDisplay();
        }

        function toggleTimer() {
            if (activePart === null) {
                // Initialize to first part if none selected
                activePart = 0;
                elapsedTimes[activePart] = elapsedTimes[activePart] || 0;
            }
            
            isRunning = !isRunning;
            
            if (isRunning) {
                timerInterval = setInterval(updateTimer, 1000);
            } else {
                clearInterval(timerInterval);
            }
            renderTimerDisplay();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadTemplate();
            updateGlobalComments();  // Add this line
        });
        
        function resetData() {
            elapsedTimes = {};
            comments = [];
            activeComment = null;
            localStorage.removeItem('meetingComments');
            updateGlobalComments();
            activePart = null;
            isRunning = false;
            clearInterval(timerInterval);
            clearInterval(commentInterval);
            commentInterval = null;
            renderTimerDisplay();
        }

        function clearLocalStorage() {
            localStorage.removeItem('meetingTemplate');
            meetingParts = DEFAULT_PARTS;
            resetData();
            renderTemplate();
            renderTimerDisplay();
        }
        function $(selector) {
            return document.querySelector(selector);
        };        
    </script>
</body>
</html>
